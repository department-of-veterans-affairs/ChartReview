<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*

Siesta 3.0.1
Copyright(c) 2009-2015 Bryntum AB
http://bryntum.com/contact
http://bryntum.com/products/siesta/license

*/
Role('Siesta.Harness.Browser.Automation.TeamCityReporter', {

    requires    : [ 'log' ],

    has : {
        isTeamCity      : false,
        tcEncodeRegExp  : /(['\[\]])/g
    },


    after : {

        onTestStart : function (test) {
            if (this.isTeamCity) this.log(&quot;##teamcity[testStarted name='&quot; + this.tcEncode(this.tcTestName(test)) + &quot;']&quot;);
        },

        onTestEnd : function (test) {
            if (this.isTeamCity) this.log(&quot;##teamcity[testFinished name='&quot; + this.tcEncode(this.tcTestName(test)) + &quot;']&quot;);
        },

        onTestUpdate : function (test, result, parentResult) {
            if (!this.isTeamCity) return;

            if (result instanceof Siesta.Result.Assertion) {
                if (result.isWaitFor &amp;&amp; !result.completed) return;

                if (!result.isTodo &amp;&amp; (result.isException || !result.passed)) {
                    this.tcFail(result)
                    return
                }
            }
        }
    },


    override : {

        start : function () {
            this.isTeamCity     = this.getQueryParam('isTeamCity') != null

            this.SUPERARG(arguments)
        },


        logWarning : function (result) {
            if (this.isTeamCity) {
                var test        = result.parent.test

                this.log(
                    &quot;##teamcity[testStdOut name='&quot; + this.tcEncode(this.tcTestName(test)) +
                    &quot;' out='[&quot;
                        + this.tcEncode(Siesta.Resource('Siesta.Role.ConsoleReporter', 'warnText') + '] ' + result) +
                    &quot;']&quot;
                )
            }

            this.SUPER(result)
        }
    },


    methods : {

        tcTestName : function (test) {
            return '.' + (test.name || test.url);
        },


        tcFail : function (result) {
            var test        = result.parent.test

            this.log(&quot;##teamcity[testFailed name='&quot; + this.tcEncode(this.tcTestName(test)) + &quot;' details='&quot; + this.tcEncode(result) + &quot;']&quot;)
        },


        tcEncode : function (text) {
            return String(text).replace(/\r/g, '|r').replace(/\n/g, '|n').replace(this.tcEncodeRegExp, '|$1')
        }
    }

})
</pre>
</body>
</html>
