<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*

Siesta 3.0.1
Copyright(c) 2009-2015 Bryntum AB
http://bryntum.com/contact
http://bryntum.com/products/siesta/license

*/
Role('Siesta.Harness.Browser.Automation.PhantomJS', {
    
    requires    : [ 'getQueryParam' ],
    
    has : {
        isPhantomJS             : false
    },
    
    
    override : {
        
        start : function () {
            if (this.getQueryParam('phantom') != null) {
                this.isAutomated        = true
                this.isPhantomJS        = true
            }
            
            this.SUPERARG(arguments)
        },
        
        
        launch : function () {
            this.SUPERARG(arguments)
            
            if (this.isPhantomJS) console.log('__PHANTOMJS__:pageCount:' + this.pageCount)
        }
    },
    
    
    after : {
        
        onTestUpdate : function (test, result, parentResult) {
            if (this.isPhantomJS) console.log('__PHANTOMJS__:keepAlive')
        },
        
        
        log : function () {
            if (this.isPhantomJS) console.log('__PHANTOMJS__:log:' + Array.prototype.slice.call(arguments).join(' '))
        },
        
        
        exit : function (code) {
            code = code || 0
            
            if (this.isPhantomJS) {
                if (this.pageCount &gt; 0) {
                    var pageReport      = this.generateUnifiedPageReport({ asJSON : true })
                    
                    console.log('__PHANTOMJS__:pageReport:' + JSON.stringify(pageReport))
                    
                    var isLastPage      = this.testPage == this.pageCount - 1
                    
                    if (this.enableCodeCoverageAutomation)
                        if (isLastPage)
                            // for last page only add the previous info (if any)
                            __PREV_COVERAGE_INFO__ &amp;&amp; this.addPreviousCoverageInfo(__PREV_COVERAGE_INFO__)
                        else  {
                            // for other pages also send the results of running this page to the launcher
                            console.log('__PHANTOMJS__:contentManagerState:' + this.getContentManagerState(true))
                            console.log('__PHANTOMJS__:coverageInfo:' + this.getRawTotalCoverageInfo(true, __PREV_COVERAGE_INFO__))
                        }
                        
                            
                    
                    if (isLastPage) {
                        __PAGE_REPORTS__.push(pageReport)
                        
                        var allReports      = __PAGE_REPORTS__
                        
                        console.log('__PHANTOMJS__:summaryMessage:' + this.getAutomatedSummaryMessage(allReports))
                        
                        if (__REPORT_OPTIONS__) {
                            __REPORT_OPTIONS__.pageReports      = allReports
                            
                            console.log('__PHANTOMJS__:combinedReport:' + this.generateReport(__REPORT_OPTIONS__))
                        }
                        
                        var me              = this
                        
                        if (this.enableCodeCoverageAutomation &amp;&amp; __COVERAGE_REPORT_FORMATS__) 
                            __COVERAGE_REPORT_FORMATS__.forEach(function (format) {
                                switch (format) {
                                    case 'html' : 
                                        console.log('__PHANTOMJS__:htmlReport:' + me.generateCoverageHtmlReport(true))
                                        break;
                                    case 'lcov' : 
                                        console.log('__PHANTOMJS__:lcovReport:' + me.generateCoverageLcovReport(true))
                                        break;
                                    case 'raw' : 
                                        console.log('__PHANTOMJS__:rawReport:' + me.generateCoverageRawReport(true))
                                        break;
                                }
                            })
                    }
                }
                // eof pageCount &gt; 0
                
                console.log('__PHANTOMJS__:exit:' + code)
            }
            // eof isPhantomJS
        }
    }
})

</pre>
</body>
</html>
